<!DOCTYPE html>
<html>
<head>
  <title>Exam Attendance ¬∑ Bal Vidya Mandir ¬∑ LAST WORKING</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Roboto, Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 30px 20px;
      background: linear-gradient(145deg, #f1eee9 0%, #e9e2d8 100%);
    }

    /* TOP PANEL - Using text symbols instead of icons */
    .top-panel {
      background: #dccdb3;
      background: linear-gradient(135deg, #ddceb4, #cebb9b);
      padding: 24px 40px;
      border-radius: 100px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
      margin-bottom: 30px;
      box-shadow: 0 16px 0 #7e6a53, 0 24px 34px rgba(0,0,0,0.3);
      border: 2px solid #ffefcf;
    }
    
    .selector-group {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 20px;
    }
    
    .selector-group span {
      font-size: 1.4rem;
      font-weight: 700;
      color: #1e353f;
    }
    
    select {
      padding: 14px 32px;
      font-size: 1.2rem;
      margin: 0 6px;
      border-radius: 60px;
      border: 3px solid #2c6470;
      background: white;
      font-weight: 600;
      color: #024e57;
      cursor: pointer;
      outline: none;
      box-shadow: 0 10px 0 #0f4a52, 0 8px 18px rgba(0,0,0,0.2);
      transition: all 0.06s;
      appearance: none;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="%23144d56" d="M7 10l5 5 5-5z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 20px center;
      padding-right: 58px;
    }
    
    select:hover {
      background-color: #fff9e6;
      border-color: #3f9eb0;
      transform: scale(1.02);
    }
    
    .print-btn {
      background: #3a606b;
      color: white;
      padding: 16px 36px;
      border-radius: 60px;
      font-size: 1.3rem;
      font-weight: 700;
      border: none;
      border-bottom: 8px solid #1e3a44;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: 0.06s;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }
    
    .print-btn:hover {
      background: #4e7e8c;
      border-bottom-width: 4px;
      transform: translateY(4px);
    }
    
    .print-btn:active {
      border-bottom-width: 2px;
      transform: translateY(6px);
    }

    /* School Header - Using text symbols */
    .school-header {
      margin-bottom: 20px;
    }
    
    h1 {
      color: #1e3a4b;
      font-size: 2.6rem;
      font-weight: 800;
      margin-bottom: 6px;
      text-shadow: 4px 4px 0 #e9d6b0;
      letter-spacing: 2px;
    }
    
    h1:before {
      content: "üè´ ";
      font-family: Arial, sans-serif;
    }
    
    h2 {
      color: #8b3c2b;
      font-size: 1.7rem;
      font-weight: 600;
      margin-top: 0;
      margin-bottom: 10px;
      border-bottom: 4px dashed #b48c5c;
      display: inline-block;
      padding-bottom: 8px;
    }
    
    h2:before {
      content: "üìå ";
      font-family: Arial, sans-serif;
    }
    
    /* Room & Date info line */
    .room-info {
      font-size: 1.4rem;
      font-weight: 600;
      color: #2d5a5c;
      background: #fff1d6;
      padding: 12px 30px;
      border-radius: 60px;
      display: inline-block;
      margin-bottom: 25px;
      box-shadow: inset 0 -4px 0 #d6a373;
      border: 2px solid #b48c5c;
    }
    
    .room-info:before {
      content: "üö™ ";
      font-family: Arial, sans-serif;
    }
    
    /* Lock Status Bar */
    .lock-status {
      background: #8b5e3c;
      color: white;
      padding: 12px 24px;
      border-radius: 60px;
      display: inline-flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      font-size: 1rem;
      font-weight: 600;
      border: 2px solid #ffefcf;
    }
    
    .lock-status.locked {
      background: #b33e3e;
    }
    
    /* Main layout - two column */
    .main-content {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 30px;
      margin-top: 20px;
    }
    
    .seating-section {
      flex: 2;
      min-width: 700px;
    }
    
    .attendance-section {
      flex: 1;
      min-width: 350px;
      background: #fcf5e6;
      border-radius: 32px;
      padding: 24px;
      box-shadow: 0 24px 40px rgba(54, 40, 28, 0.3);
      border: 4px solid #9c8a72;
      height: fit-content;
      display: flex;
      flex-direction: column;
    }
    
    #seatingPlan {
      display: flex;
      justify-content: center;
    }
    
    table {
      margin: 10px auto;
      border-collapse: collapse;
      background: #fcf5e6;
      border-radius: 32px;
      overflow: hidden;
      box-shadow: 0 24px 40px rgba(54, 40, 28, 0.5);
      border: 4px solid #9c8a72;
    }
    td {
      border: 2px solid #3a5a5e;
      padding: 14px 8px;
      width: 180px;
      height: 140px;
      text-align: center;
      vertical-align: middle;
      font-size: 14px;
      line-height: 1.6;
      font-weight: 500;
      background-color: #fffef7;
      box-shadow: inset 0 -3px 0 rgba(0,0,0,0.05);
      transition: 0.1s;
      cursor: pointer;
    }
    .present {
      background: linear-gradient(145deg, #b8f0a8, #9be085);
      background-color: #b3e8a3;
      border-bottom: 8px solid #2e7d32;
    }
    .noexam {
      background: linear-gradient(145deg, #e0e0e0, #c9c9c9);
      background-color: #d6d6d6;
      border-bottom: 8px solid #616161;
      cursor: default;
    }
    .absent {
      background: linear-gradient(145deg, #f7aaaa, #f08080);
      background-color: #f0a0a0;
      border-bottom: 8px solid #b33e3e;
      color: #4a1e1e;
    }
    
    /* SUMMARY TABLE */
    .summary-container {
      width: 100%;
      margin-bottom: 25px;
      background: #fff9e6;
      border-radius: 24px;
      padding: 15px;
      border: 3px solid #9c8a72;
    }
    
    .summary-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: #1e3a4b;
      margin-bottom: 12px;
      border-bottom: 3px solid #b48c5c;
      display: inline-block;
      padding-bottom: 5px;
    }
    
    .summary-title:before {
      content: "üìä ";
      font-family: Arial, sans-serif;
    }
    
    .summary-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 16px;
      overflow: hidden;
    }
    
    .summary-table th {
      background: #5e7c87;
      color: white;
      padding: 10px;
      font-size: 0.95rem;
      font-weight: 600;
    }
    
    .summary-table td {
      padding: 8px;
      border: 1px solid #b0a088;
      text-align: center;
      font-size: 0.95rem;
      font-weight: 500;
      background: #fffcf3;
      height: auto;
      cursor: default;
    }
    
    .summary-table tr:last-child td {
      background: #e6dcc0;
      font-weight: 700;
      border-top: 2px solid #6b5a48;
    }
    
    /* Attendance table styles */
    .attendance-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .attendance-stats {
      background: #3a606b;
      color: white;
      padding: 12px 20px;
      border-radius: 50px;
      font-size: 1.2rem;
      font-weight: 700;
    }
    .temp-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 16px;
      overflow: hidden;
    }
    .temp-table th {
      background: #5e7c87;
      color: white;
      padding: 12px;
      font-size: 1rem;
    }
    .temp-table td {
      padding: 10px;
      border: 1px solid #b0a088;
      width: auto;
      height: auto;
      background: #fffaf0;
      cursor: default;
    }
    .absent-row {
      background: #ffe0e0;
    }
    
    /* Button container */
    .button-container {
      display: flex;
      gap: 15px;
      margin-top: 20px;
      justify-content: center;
    }
    
    .btn-reset, .btn-submit {
      border: none;
      border-radius: 50px;
      padding: 12px 24px;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      border-bottom: 6px solid #5a3e28;
      transition: 0.06s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-reset {
      background: #8b5e3c;
      color: white;
    }
    
    .btn-submit {
      background: #2a7f6e;
      color: white;
      border-bottom-color: #1a5347;
    }
    
    .btn-reset:hover {
      background: #a8754a;
      border-bottom-width: 3px;
      transform: translateY(3px);
    }
    
    .btn-submit:hover {
      background: #3aa08b;
      border-bottom-width: 3px;
      transform: translateY(3px);
    }
    
    .btn-submit:disabled, .btn-reset:disabled {
      background: #cccccc;
      border-bottom-color: #999999;
      cursor: not-allowed;
      transform: none;
    }
    
    .footer {
      margin-top: 50px;
      color: #1f463e;
      font-size: 1.2rem;
      background: #eadbbc;
      padding: 16px 40px;
      border-radius: 60px;
      display: inline-block;
      font-weight: 700;
      box-shadow: inset 0 -6px 0 #b38b5b;
    }
    
    .footer span:before {
      content: "üü¢ PRESENT | üî¥ ABSENT | ‚ö™ NO EXAM";
      font-family: Arial, sans-serif;
    }
    
    .badge {
      background: #3a606b;
      color: white;
      padding: 8px 20px;
      border-radius: 50px;
      font-size: 1rem;
      margin-left: 12px;
    }
    .subject-badge {
      background: #1e5f5a;
      color: white;
      padding: 4px 12px;
      border-radius: 40px;
      display: inline-block;
      margin-top: 4px;
      font-weight: 600;
    }
    
    /* Print styles - UPDATED for FULL PAGE WIDTH */
    @media print {
      @page {
        size: A4 portrait;
        margin: 0.5cm; /* Reduced margins for full width usage */
      }
      
      html, body { 
        background: white; 
        margin: 0; 
        padding: 0;
        width: 100%;
        height: 100%;
      }
      
      /* Hide all UI controls */
      .top-panel, .lock-status, .attendance-section, .btn-reset, .btn-submit, 
      .print-btn, select, .footer, .badge {
        display: none !important;
      }
      
      /* School header - first 3 lines - compact */
      .school-header { 
        display: block !important; 
        margin: 0 0 2px 0 !important; 
      }
      
      h1 { 
        font-size: 1.2rem !important; 
        color: black !important; 
        text-shadow: none !important; 
        margin: 0 0 1px 0 !important;
      }
      
      h1:before {
        content: "üè´ " !important;
      }
      
      h2 { 
        font-size: 1rem !important; 
        color: black !important; 
        border-bottom: 1px solid black !important;
        margin: 0 0 2px 0 !important;
        padding-bottom: 1px !important;
      }
      
      h2:before {
        content: "üìå " !important;
      }
      
      .room-info { 
        display: block !important; 
        font-size: 0.85rem !important; 
        background: #f0f0f0 !important; 
        color: black !important; 
        border: 1px solid black !important; 
        box-shadow: none !important;
        padding: 2px 10px !important;
        margin-bottom: 5px !important;
      }
      
      .room-info:before {
        content: "üö™ " !important;
      }
      
      /* Main content - seating plan takes full width */
      .main-content {
        display: block !important;
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
      }
      
      .seating-section {
        display: block !important;
        width: 100% !important;
        min-width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
      }
      
      /* Seating plan table - maximize space - FULL WIDTH */
      #seatingPlan {
        display: flex !important;
        justify-content: center !important;
        margin: 0 !important;
        width: 100% !important;
      }
      
      table {
        margin: 0 auto !important;
        box-shadow: none !important;
        border: 2px solid black !important;
        border-radius: 4px !important;
        width: 100% !important; /* Take full width */
        max-width: 100% !important;
        font-size: 8px !important;
        table-layout: fixed !important; /* Distribute columns evenly */
      }
      
      td {
        border: 1px solid black !important;
        background: white !important;
        padding: 2px 1px !important;
        height: auto !important;
        width: auto !important;
        min-width: auto !important;
        word-wrap: break-word !important;
        font-size: 7px !important;
        line-height: 1.2 !important;
      }
      
      .present { 
        background: #e0f0e0 !important; 
        border-bottom: 1px solid #2e7d32 !important;
      }
      .absent { 
        background: #ffe0e0 !important; 
        border-bottom: 1px solid #b33e3e !important;
      }
      .noexam { 
        background: #e0e0e0 !important; 
        border-bottom: 1px solid #616161 !important;
      }
      
      /* Subject badge in print */
      .subject-badge {
        padding: 1px 3px !important;
        font-size: 6px !important;
      }
      
      /* Summary container - positioned at bottom - FULL WIDTH */
      .summary-container {
        display: block !important;
        background: white !important;
        border: 2px solid black !important;
        border-radius: 4px !important;
        margin: 5px 0 0 0 !important;
        padding: 3px !important;
        width: 100% !important;
        page-break-before: avoid !important;
        page-break-inside: avoid !important;
      }
      
      .summary-title {
        font-size: 0.8rem !important;
        color: black !important;
        border-bottom: 1px solid black !important;
        margin-bottom: 2px !important;
      }
      
      .summary-title:before {
        content: "üìä " !important;
      }
      
      .summary-table {
        border: 1px solid black !important;
        font-size: 0.65rem !important;
        width: 100% !important;
      }
      
      .summary-table th {
        background: #e0e0e0 !important;
        color: black !important;
        padding: 2px !important;
        font-size: 0.65rem !important;
      }
      
      .summary-table td {
        padding: 1px !important;
        border: 1px solid black !important;
        font-size: 0.65rem !important;
      }
      
      /* Ensure proper page layout */
      .school-header, .room-info {
        page-break-after: avoid !important;
      }
      
      .seating-section {
        page-break-before: avoid !important;
        page-break-after: avoid !important;
      }
    }
  </style>
  <!-- Font Awesome - REMOVED to prevent loading issues on other machines -->
  <!-- Using system fonts and text symbols instead -->
</head>
<body>
  <!-- TOP PANEL - Using text symbols in dropdown options -->
  <div class="top-panel">
    <div class="selector-group">
      <span>üö™ ROOM</span>
      <select id="roomDropdown"><option>üåÄ loading rooms...</option></select>
      <span>üìÖ ON</span>
      <select id="examDate"><option>üìÖ loading dates...</option></select>
    </div>
    <button class="print-btn" id="printBtn">
      üñ®Ô∏è PRINT
    </button>
  </div>

  <!-- LOCK STATUS BAR -->
  <div id="lockStatusBar" class="lock-status">
    üîí Current Selection Status: 
    <span id="lockStatusText">Not submitted</span>
  </div>

  <!-- SCHOOL HEADER - Text symbols already in CSS :before -->
  <div class="school-header">
    <h1>BAL VIDYA MANDIR, SAMBHAL</h1>
    <h2>EXAMINATION ATTENDANCE ¬∑ ROOM WISE SEATING</h2>
  </div>

  <!-- ROOM & DATE INFO -->
  <div id="roomInfoDisplay" class="room-info">
    Room: <span id="displayRoom">‚Äî</span>  |  üìÖ Date: <span id="displayDate">‚Äî</span>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main-content">
    <!-- SEATING PLAN SECTION -->
    <div class="seating-section">
      <div id="seatingPlan"></div>
      <!-- ROOM ATTENDANCE SUMMARY -->
      <div class="summary-container">
        <div class="summary-title">ROOM ATTENDANCE SUMMARY</div>
        <table class="summary-table" id="summaryTable">
          <thead>
            <tr>
              <th>Class</th>
              <th>From</th>
              <th>To</th>
              <th>Last</th>
              <th>Total</th>
              <th>Absent</th>
              <th>Present</th>
            </tr>
          </thead>
          <tbody id="summaryBody">
            <tr><td colspan="7">üìå Loading summary...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- ATTENDANCE REGISTER SECTION -->
    <div class="attendance-section">
      <div class="attendance-header">
        <h2 style="font-size: 1.6rem;">üìã ATTENDANCE REGISTER</h2>
        <div class="attendance-stats">
          <span id="absentCount">0</span> ABSENT
        </div>
      </div>
      <div style="max-height: 400px; overflow-y: auto;">
        <table class="temp-table" id="attendanceTable">
          <thead>
            <tr>
              <th>ROLL</th>
              <th>NAME</th>
              <th>CLASS</th>
              <th>SUBJECT</th>
              <th>STATUS</th>
            </tr>
          </thead>
          <tbody id="attendanceBody">
            <tr><td colspan="5">üëÜ Click on PRESENT cells to mark ABSENT</td></tr>
          </tbody>
        </table>
      </div>
      <div class="button-container">
        <button class="btn-reset" id="resetAttendanceBtn">
          ‚Ü©Ô∏è RESET
        </button>
        <button class="btn-submit" id="submitAttendanceBtn">
          ‚úÖ SUBMIT
        </button>
      </div>
    </div>
  </div>
  
  <div class="footer">
    <span></span> <!-- Content in CSS :before -->
  </div>

  <script>
    (function() {
      "use strict";

      // ============ CONFIGURATION ============
      const SHEET_ID = "1PdwXDCW20w8qlW8yVbGyz4NuzV-il2wKsOUPQgW0J7E";
      const API_KEY = "AIzaSyA8IuP2YVIxNZlZYwbBMePjhRFKjicfWlg";
      const SUBMIT_SHEET_ID = "1dL-YdDxdF778Vnut90Rd2cRLQ_B7tlMKL1BsyXp0EYE";
      // ===== YOUR WORKING APPS SCRIPT URL - FIXED =====
      const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz663BG5IlGsWTC9Ay6Vy0tfNEIWk_sKFn9qIBizcebOUUMOtKBTkLexAFmMLiUqRM/exec";

      // ============ DOM ELEMENTS ============
      const roomDropdown = document.getElementById("roomDropdown");
      const dateDropdown = document.getElementById("examDate");
      const seatingDiv = document.getElementById("seatingPlan");
      const attendanceBody = document.getElementById("attendanceBody");
      const absentCountSpan = document.getElementById("absentCount");
      const resetBtn = document.getElementById("resetAttendanceBtn");
      const submitBtn = document.getElementById("submitAttendanceBtn");
      const printBtn = document.getElementById("printBtn");
      const displayRoomSpan = document.getElementById("displayRoom");
      const displayDateSpan = document.getElementById("displayDate");
      const summaryBody = document.getElementById("summaryBody");
      const lockStatusText = document.getElementById("lockStatusText");
      const lockStatusBar = document.getElementById("lockStatusBar");

      // ============ STATE ============
      let absentList = [];
      let currentRoomBlocks = [];
      let currentRoomNo = "";
      let currentDate = "";
      let isCurrentSelectionLocked = false;
      let cachedSheet1 = null, cachedSheet2 = null, cachedSheet3 = null, cachedSheet4 = null;

      // ============ FETCH HELPERS ============
      async function fetchSheet(range) {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${range}?key=${API_KEY}`;
        const res = await fetch(url);
        const data = await res.json();
        if (data.error) throw new Error(data.error.message);
        return data;
      }

      // ============ LOAD ALL SHEETS ============
      async function loadAllSheets() {
        if (!cachedSheet1) cachedSheet1 = await fetchSheet("Sheet1");
        if (!cachedSheet2) cachedSheet2 = await fetchSheet("Sheet2");
        if (!cachedSheet3) cachedSheet3 = await fetchSheet("Sheet3");
        if (!cachedSheet4) cachedSheet4 = await fetchSheet("Sheet4");
      }

      // ============ LOAD ROOMS ============
      async function loadRooms() {
        try {
          const data = await fetchSheet("Sheet1!A2:A");
          roomDropdown.innerHTML = "";
          if (data.values) {
            data.values.forEach(row => {
              const room = row?.[0]?.trim();
              if (room) {
                const opt = document.createElement("option");
                opt.value = room;
                opt.textContent = `üö™ ${room}`;
                roomDropdown.appendChild(opt);
              }
            });
          }
        } catch (e) {
          console.warn("Room fetch failed", e);
        }
      }

      // ============ LOAD DATES ============
      async function loadDates() {
        try {
          const data = await fetchSheet("Sheet2!B1:Z1");
          dateDropdown.innerHTML = "";
          if (data.values && data.values[0]) {
            data.values[0].forEach(date => {
              if (date?.trim()) {
                const opt = document.createElement("option");
                opt.value = date.trim();
                opt.textContent = `üìÖ ${date.trim()}`;
                dateDropdown.appendChild(opt);
              }
            });
          }
        } catch (e) {
          console.warn("Date fetch failed", e);
        }
      }

      // ============ CHECK IF ATTENDANCE ALREADY SUBMITTED ============
      async function checkIfSubmitted(roomNo, date) {
        const dateIndex = Array.from(dateDropdown.options).map(opt => opt.value).indexOf(date);
        if (dateIndex === -1) return false;
        const sheetName = `p${dateIndex + 1}`;
        try {
          const url = `https://sheets.googleapis.com/v4/spreadsheets/${SUBMIT_SHEET_ID}/values/${sheetName}!A:F?key=${API_KEY}`;
          const response = await fetch(url);
          const data = await response.json();
          if (data.values && data.values.length > 1) {
            for (let i = 1; i < data.values.length; i++) {
              const row = data.values[i];
              if (row[4] === roomNo && row[5] === date) return true;
            }
          }
          return false;
        } catch (error) {
          return false;
        }
      }

      // ============ LOAD PREVIOUS ATTENDANCE ============
      async function loadPreviousAttendance(roomNo, date) {
        const dateIndex = Array.from(dateDropdown.options).map(opt => opt.value).indexOf(date);
        if (dateIndex === -1) return false;
        const sheetName = `p${dateIndex + 1}`;
        try {
          const url = `https://sheets.googleapis.com/v4/spreadsheets/${SUBMIT_SHEET_ID}/values/${sheetName}!A:F?key=${API_KEY}`;
          const response = await fetch(url);
          const data = await response.json();
          if (data.values && data.values.length > 1) {
            const previousAbsent = [];
            for (let i = 1; i < data.values.length; i++) {
              const row = data.values[i];
              if (row[4] === roomNo && row[5] === date) {
                if (row[0] === "ALL_PRESENT") continue;
                previousAbsent.push({
                  roll: row[0],
                  name: row[1],
                  className: row[2],
                  subject: row[3],
                  room: roomNo,
                  date: date
                });
              }
            }
            if (previousAbsent.length > 0) {
              absentList = previousAbsent;
              isCurrentSelectionLocked = true;
              lockCurrentSelection(true);
              renderAttendanceTable();
              renderSummaryTable();
              return true;
            }
          }
          return false;
        } catch (error) {
          return false;
        }
      }

      // ============ LOCK CURRENT SELECTION ============
      function lockCurrentSelection(locked) {
        isCurrentSelectionLocked = locked;
        if (locked) {
          lockStatusText.innerText = `üîí LOCKED - Room ${currentRoomNo} on ${currentDate}`;
          lockStatusBar.classList.add('locked');
          submitBtn.disabled = true;
          resetBtn.disabled = true;
          document.querySelectorAll('td.present, td.absent').forEach(cell => {
            cell.style.cursor = 'not-allowed';
            const newCell = cell.cloneNode(true);
            cell.parentNode.replaceChild(newCell, cell);
          });
        } else {
          lockStatusText.innerText = 'Not submitted - Editable';
          lockStatusBar.classList.remove('locked');
          submitBtn.disabled = false;
          resetBtn.disabled = false;
        }
      }

      // ============ SUBJECT MAPS ============
      function getSubjectMap(selectedDate) {
        if (!cachedSheet2?.values) return {};
        const header = cachedSheet2.values[0];
        let dateIdx = -1;
        for (let i=0; i<header.length; i++) {
          if (header[i]?.trim() === selectedDate) { dateIdx = i; break; }
        }
        if (dateIdx === -1) return {};
        const map = {};
        for (let r=1; r<cachedSheet2.values.length; r++) {
          const row = cachedSheet2.values[r];
          const cls = row[0]?.trim();
          if (cls && row[dateIdx]) map[cls] = row[dateIdx].trim();
        }
        return map;
      }

      function getSheet4Lookup(selectedDate) {
        if (!cachedSheet4?.values) return {};
        const header = cachedSheet4.values[0];
        let dateIdx = -1;
        for (let i=0; i<header.length; i++) {
          if (header[i]?.trim() === selectedDate) { dateIdx = i; break; }
        }
        if (dateIdx === -1) return {};
        const lookup = {};
        for (let r=1; r<cachedSheet4.values.length; r++) {
          const row = cachedSheet4.values[r];
          const roll = row[0]?.toString().trim();
          const classSec = row[5]?.toString().trim();
          if (roll && classSec) {
            const subj = row[dateIdx]?.toString().trim() || "";
            lookup[`${classSec}_${roll}`] = subj;
          }
        }
        return lookup;
      }

      // ============ BLOCK PARSING ============
      function parseBlocksFromRow(planRow) {
        let blocks = [];
        for (let i = 2; i < planRow.length; i += 3) {
          if (i + 2 < planRow.length) {
            let className = planRow[i];
            let startRoll = planRow[i+1];
            let endRoll = planRow[i+2];
            if (className && startRoll && endRoll) {
              className = className.toString().trim();
              const start = parseInt(startRoll.toString().trim(), 10);
              const end = parseInt(endRoll.toString().trim(), 10);
              
              // Keep all blocks for seating plan
              if (!isNaN(start) && !isNaN(end) && className !== "") {
                blocks.push({
                  className: className,
                  startRoll: start,
                  endRoll: end,
                  currentRoll: start,
                  originalIndex: i,
                  totalStudents: end - start + 1
                });
              }
            }
          }
        }
        return blocks;
      }

      // ============ RENDER SUMMARY ============
      function renderSummaryTable() {
        if (!currentRoomBlocks || currentRoomBlocks.length === 0) {
          summaryBody.innerHTML = '<tr><td colspan="7">üìå No class data for this room</td></tr>';
          return;
        }
        
        // Filter out blocks with start=0 AND end=0 for the summary
        const filteredBlocks = currentRoomBlocks.filter(block => 
          !(block.startRoll === 0 && block.endRoll === 0)
        );
        
        if (filteredBlocks.length === 0) {
          summaryBody.innerHTML = '<tr><td colspan="7">üìå No valid class data for summary</td></tr>';
          return;
        }
        
        let totalStudents = 0, totalAbsent = 0, totalPresent = 0;
        let html = '';
        
        filteredBlocks.forEach(block => {
          const total = block.totalStudents;
          const absentCount = absentList.filter(item => item.className === block.className).length;
          const presentCount = total - absentCount;
          totalStudents += total;
          totalAbsent += absentCount;
          totalPresent += presentCount;
          html += `<tr>
            <td><strong>${block.className}</strong></td>
            <td>${block.startRoll}</td>
            <td>${block.endRoll}</td>
            <td>${block.endRoll}</td>
            <td>${total}</td>
            <td style="color: #b33e3e;">${absentCount}</td>
            <td style="color: #2e7d32;">${presentCount}</td>
          </tr>`;
        });
        
        html += `<tr>
          <td colspan="4"><strong>TOTAL</strong></td>
          <td><strong>${totalStudents}</strong></td>
          <td><strong style="color: #b33e3e;">${totalAbsent}</strong></td>
          <td><strong style="color: #2e7d32;">${totalPresent}</strong></td>
        </tr>`;
        
        summaryBody.innerHTML = html;
      }

      // ============ ATTENDANCE TOGGLE ============
      function toggleAttendance(cell, studentData) {
        if (isCurrentSelectionLocked) {
          alert(`‚ùå Attendance for Room ${currentRoomNo} on ${currentDate} is already submitted and LOCKED.`);
          return;
        }
        if (!studentData) return;
        const { roll, name, className, subject } = studentData;
        const existingIndex = absentList.findIndex(
          item => String(item.roll) === String(roll) && item.className === className
        );
        if (cell.classList.contains("absent")) {
          cell.classList.remove("absent");
          cell.classList.add("present");
          cell.innerHTML = studentData.originalHTML;
          if (existingIndex !== -1) absentList.splice(existingIndex, 1);
        } else {
          cell.classList.remove("present");
          cell.classList.add("absent");
          studentData.originalHTML = cell.innerHTML;
          const studentName = name || '';
          cell.innerHTML = `<strong style="font-size:1.1rem;">${roll}</strong><br>${studentName}<br>${className}<br><span style="background:#b33e3e; color:white; padding:4px 12px; border-radius:40px;">‚ùå ABSENT</span>`;
          if (existingIndex === -1) {
            absentList.push({
              roll: String(roll), 
              name: studentName, 
              className, 
              subject,
              room: currentRoomNo, 
              date: currentDate
            });
          }
        }
        renderAttendanceTable();
        renderSummaryTable();
      }

      // ============ RENDER ATTENDANCE TABLE ============
      function renderAttendanceTable() {
        if (absentList.length === 0) {
          attendanceBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px;">‚úÖ No absent students marked</td></tr>';
          absentCountSpan.innerText = '0';
          return;
        }
        let html = '';
        absentList.forEach(item => {
          html += `<tr class="absent-row">
            <td><strong>${item.roll}</strong></td>
            <td>${item.name || '‚Äî'}</td>
            <td>${item.className}</td>
            <td>${item.subject || '‚Äî'}</td>
            <td><span style="background:#b33e3e; color:white; padding:4px 12px; border-radius:40px;">ABSENT</span></td>
          </tr>`;
        });
        attendanceBody.innerHTML = html;
        absentCountSpan.innerText = absentList.length;
      }

      // ============ RESET ATTENDANCE ============
      function resetAttendance() {
        if (isCurrentSelectionLocked) {
          alert(`‚ùå Cannot reset - Room ${currentRoomNo} on ${currentDate} is already submitted and LOCKED.`);
          return;
        }
        absentList = [];
        loadSeatingPlan(currentRoomNo, currentDate);
      }

      // ============ SUBMIT ATTENDANCE - FIXED VERSION ============
      async function submitAttendance() {
        if (isCurrentSelectionLocked) {
          alert(`‚ùå Attendance for Room ${currentRoomNo} on ${currentDate} is already submitted and LOCKED.`);
          return;
        }
        
        const selectedDate = dateDropdown.value;
        const dateOptions = Array.from(dateDropdown.options).map(opt => opt.value);
        const dateIndex = dateOptions.indexOf(selectedDate);
        if (dateIndex === -1) {
          alert("‚ùå Please select a valid date.");
          return;
        }
        const sheetName = `p${dateIndex + 1}`;
        const alreadySubmitted = await checkIfSubmitted(currentRoomNo, selectedDate);
        if (alreadySubmitted) {
          alert(`‚ùå Attendance for Room ${currentRoomNo} on ${selectedDate} is already submitted and LOCKED.`);
          isCurrentSelectionLocked = true;
          lockCurrentSelection(true);
          return;
        }
        if (!confirm(`üì§ Submit attendance to sheet "${sheetName}"?\n\nRoom: ${currentRoomNo}\nDate: ${selectedDate}\nAbsent Students: ${absentList.length}\n\n‚ö†Ô∏è After submission, this room and date will be LOCKED!`)) {
          return;
        }
        
        const values = [];
        
        if (absentList.length > 0) {
          // If there are absent students, send their details
          absentList.forEach(item => {
            values.push([
              item.roll.toString(),
              item.name || '',
              item.className || '',
              item.subject || '',
              currentRoomNo,
              selectedDate
            ]);
          });
        } else {
          // ALL STUDENTS PRESENT - Get a representative class from the room blocks
          // Filter out blocks with start=0 AND end=0 (like "BREAK" periods)
          const validBlocks = currentRoomBlocks.filter(block => 
            !(block.startRoll === 0 && block.endRoll === 0)
          );
          
          let representativeClass = "UNKNOWN";
          let representativeSubject = "ALL_PRESENT";
          
          if (validBlocks.length > 0) {
            // Use the first valid class as representative
            representativeClass = validBlocks[0].className;
            
            // Get subject for this class based on date
            const subjectMapU10 = getSubjectMap(selectedDate);
            const sheet4Lookup = getSheet4Lookup(selectedDate);
            
            if (representativeClass.startsWith("11") || representativeClass.startsWith("12")) {
              // For classes 11-12, try to get subject from first student
              const firstRoll = validBlocks[0].startRoll;
              representativeSubject = sheet4Lookup[`${representativeClass}_${firstRoll}`] || "ALL_PRESENT";
            } else {
              // For classes up to 10, get subject from subject map
              representativeSubject = subjectMapU10[representativeClass] || "ALL_PRESENT";
            }
          }
          
          values.push([
            "ALL_PRESENT",
            "ALL_PRESENT",
            representativeClass,  // Now contains actual class name, not "ALL_PRESENT"
            representativeSubject,
            currentRoomNo,
            selectedDate
          ]);
        }
        
        submitBtn.innerHTML = '‚è≥ SUBMITTING...';
        submitBtn.disabled = true;
        try {
          await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sheetName: sheetName, values: values })
          });
          isCurrentSelectionLocked = true;
          lockCurrentSelection(true);
          alert(`‚úÖ SUCCESS!\n\nRoom: ${currentRoomNo}\nDate: ${selectedDate}\nAbsent Students: ${absentList.length}\n\nüîí This room and date is now LOCKED.`);
        } catch (error) {
          console.error('Submit error:', error);
          alert(`‚ùå Submission failed: ${error.message}`);
          submitBtn.innerHTML = '‚úÖ SUBMIT';
          submitBtn.disabled = false;
        }
      }

      // ============ üñ®Ô∏è PRINT ============
      function printSeatingOnly() {
        window.print();
      }

      // ============ MAIN SEATING ENGINE - LAST WORKING VERSION ============
      async function loadSeatingPlan(roomNo, selectedDate) {
        if (!roomNo || !selectedDate) return;
        console.log(`Loading room: ${roomNo}, date: ${selectedDate}`);

        const isThisLocked = await checkIfSubmitted(roomNo, selectedDate);
        await loadAllSheets();

        currentRoomNo = roomNo;
        currentDate = selectedDate;
        displayRoomSpan.innerText = roomNo;
        displayDateSpan.innerText = selectedDate;

        absentList = [];
        isCurrentSelectionLocked = false;
        lockCurrentSelection(false);

        const planRow = cachedSheet1.values.find(r => r[0]?.toString().trim() === roomNo);
        if (!planRow) {
          seatingDiv.innerHTML = `<p>üìå No plan for room ${roomNo}</p>`;
          currentRoomBlocks = [];
          renderSummaryTable();
          renderAttendanceTable();
          return;
        }

        const arrangement = planRow[1]?.toString().trim();
        if (!arrangement?.includes('X')) {
          currentRoomBlocks = [];
          renderSummaryTable();
          return;
        }

        const [rows, cols] = arrangement.split('X').map(Number);
        let allBlocks = parseBlocksFromRow(planRow);
        currentRoomBlocks = allBlocks.map(block => ({...block, currentRoll: block.startRoll}));
        
        console.log(`Room ${roomNo} has ${allBlocks.length} blocks:`, 
          allBlocks.map(b => `${b.className} (${b.startRoll}-${b.endRoll})`).join(', '));

        await loadPreviousAttendance(roomNo, selectedDate);
        if (isThisLocked && absentList.length === 0) {
          isCurrentSelectionLocked = true;
          lockCurrentSelection(true);
        }

        // Split blocks into even and odd indexed groups
        let evenBlocks = [];
        let oddBlocks = [];
        
        for (let i = 0; i < allBlocks.length; i++) {
          if (i % 2 === 0) {
            evenBlocks.push({...allBlocks[i], currentRoll: allBlocks[i].startRoll});
          } else {
            oddBlocks.push({...allBlocks[i], currentRoll: allBlocks[i].startRoll});
          }
        }
        
        console.log(`Even blocks:`, evenBlocks.map(b => `${b.className} (${b.startRoll}-${b.endRoll})`));
        console.log(`Odd blocks:`, oddBlocks.map(b => `${b.className} (${b.startRoll}-${b.endRoll})`));

        // Student map
        const studentMap = new Map();
        if (cachedSheet3?.values) {
          for (let i=1; i<cachedSheet3.values.length; i++) {
            const row = cachedSheet3.values[i];
            const roll = parseInt(row[0], 10);
            const className = row[5]?.toString().trim();
            if (roll && className) {
              studentMap.set(`${className}_${roll}`, {
                roll, 
                name: row[2]?.toString().trim() || '', 
                class: className
              });
            }
          }
        }

        const subjectMapU10 = getSubjectMap(selectedDate);
        const sheet4Lookup = getSheet4Lookup(selectedDate);

        // Build table
        const table = document.createElement("table");
        for (let r = 0; r < rows; r++) table.appendChild(document.createElement("tr"));

        // Fill table column by column
        for (let c = 0; c < cols; c++) {
          // Determine which block list to use based on column parity
          const isEvenColumn = (c % 2 === 0);
          let currentBlockList = isEvenColumn ? evenBlocks : oddBlocks;
          
          // Find first non-exhausted block in this list
          let currentBlock = null;
          for (let i = 0; i < currentBlockList.length; i++) {
            if (currentBlockList[i].currentRoll <= currentBlockList[i].endRoll) {
              currentBlock = currentBlockList[i];
              break;
            }
          }

          for (let r = 0; r < rows; r++) {
            const tr = table.rows[r];
            const td = document.createElement("td");

            if (currentBlock && currentBlock.currentRoll <= currentBlock.endRoll) {
              const rollNo = currentBlock.currentRoll;
              const className = currentBlock.className;
              const student = studentMap.get(`${className}_${rollNo}`);

              let subj = "";
              if (className.startsWith("11") || className.startsWith("12")) {
                subj = sheet4Lookup[`${className}_${rollNo}`] || "";
              } else {
                subj = subjectMapU10[className] || "";
              }

              if (subj) {
                td.classList.add("present");
                const studentData = {
                  roll: rollNo, 
                  name: student?.name || '', 
                  className, 
                  subject: subj,
                  room: roomNo, 
                  date: selectedDate
                };
                
                if (student) {
                  td.innerHTML = `<strong style="font-size:1.1rem;">${student.roll}</strong><br>${student.name || ''}<br>${student.class}<br><span class="subject-badge">${subj}</span><br>‚úÖ PRESENT`;
                } else {
                  td.innerHTML = `<strong style="font-size:1.1rem;">${rollNo}</strong><br>${className}<br><span class="subject-badge">${subj}</span><br>‚úÖ PRESENT`;
                }
                
                const isAbsent = absentList.some(item => String(item.roll) === String(rollNo) && item.className === className);
                if (isAbsent) {
                  td.classList.remove('present');
                  td.classList.add('absent');
                  td.innerHTML = `<strong style="font-size:1.1rem;">${rollNo}</strong><br>${student?.name || ''}<br>${className}<br><span style="background:#b33e3e; color:white; padding:4px 12px; border-radius:40px;">‚ùå ABSENT</span>`;
                }
                
                td.addEventListener('click', (function(cell, data) {
                  return function(e) {
                    e.stopPropagation();
                    toggleAttendance(cell, data);
                  };
                })(td, studentData));
                
              } else {
                td.classList.add("noexam");
                if (student) {
                  td.innerHTML = `<strong style="font-size:1.1rem;">${student.roll}</strong><br>${student.name || ''}<br>${student.class}<br>üö´ NO EXAM`;
                } else {
                  td.innerHTML = `<strong style="font-size:1.1rem;">${rollNo}</strong><br>${className}<br>üö´ NO EXAM`;
                }
              }

              // Increment roll
              currentBlock.currentRoll++;
              
              // Check if current block exhausted and move to next
              if (currentBlock.currentRoll > currentBlock.endRoll) {
                // Find next non-exhausted block in the same list
                currentBlock = null;
                for (let i = 0; i < currentBlockList.length; i++) {
                  if (currentBlockList[i].currentRoll <= currentBlockList[i].endRoll) {
                    currentBlock = currentBlockList[i];
                    break;
                  }
                }
              }
            } else {
              td.innerHTML = "‚Äî ¬∑ ‚Äî";
            }
            tr.appendChild(td);
          }
        }

        seatingDiv.innerHTML = "";
        seatingDiv.appendChild(table);
        renderSummaryTable();
        renderAttendanceTable();
      }

      // ============ EVENT LISTENERS ============
      roomDropdown.addEventListener("change", async () => {
        if (roomDropdown.value && dateDropdown.value) {
          await loadSeatingPlan(roomDropdown.value, dateDropdown.value);
        }
      });
      
      dateDropdown.addEventListener("change", async () => {
        if (roomDropdown.value && dateDropdown.value) {
          await loadSeatingPlan(roomDropdown.value, dateDropdown.value);
        }
      });

      resetBtn.addEventListener("click", resetAttendance);
      submitBtn.addEventListener("click", submitAttendance);
      printBtn.addEventListener("click", printSeatingOnly);

      // ============ INITIALISE ============
      window.addEventListener("load", async () => {
        await loadRooms();
        await loadDates();
        await loadAllSheets();
        if (roomDropdown.options.length > 0) roomDropdown.selectedIndex = 0;
        if (dateDropdown.options.length > 0) dateDropdown.selectedIndex = 0;
        if (roomDropdown.value && dateDropdown.value) {
          await loadSeatingPlan(roomDropdown.value, dateDropdown.value);
        }
      });

    })();
  </script>
</body>
</html>
